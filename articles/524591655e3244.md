---
title: "Golangã¨Clean Architectureã§APIã‚µãƒ¼ãƒãƒ¼ã‚’æ§‹ç¯‰ã—ã¦ã¿ãŸ"
emoji: "ğŸ¦”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["go", "gorm", "goa", "swagger", "cleanarchitecture"]
published: true
---

# ç›®çš„
ã©ã†ã‚‚ã€@yanteraã§ã™ã€‚
Goã§å®Ÿéš›ã«Clean Architectureã§é–‹ç™ºã™ã‚‹å ´åˆã©ã®ã‚ˆã†ãªæ§‹ç¯‰ã‚’ã™ã‚Œã°ã€é–‹ç™ºã—ã‚„ã™ã„ã®ã‹è¨­è¨ˆã—ã¦ã¿ã¾ã—ãŸã€‚
å®Ÿè·µã‚’æƒ³å®šã—ã¦æ§‹ç¯‰ã‚’è€ƒãˆã¦ã„ã¾ã™ã€‚APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ä»£ã‚ã‚Šã«sawaggerã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚
# ä½¿ç”¨ã™ã‚‹ãƒ„ãƒ¼ãƒ«
- docker
- echo(air)
- gorm
- swagger
- goa
# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ
```
â”œâ”€ docker/
    â”œâ”€ api
        â””â”€ environments
            â”œâ”€ production/
            â”œâ”€ development/
            â””â”€ test/
    â”œâ”€ document
    â””â”€ mysql 
â”œâ”€ documents/
    â””â”€ design/
â”œâ”€ server/
    â”œâ”€ adapters/
        â”œâ”€ controllers/
        â”œâ”€ gateways/
        â””â”€ presenter/
    â”œâ”€ infrastructure/
        â”œâ”€ routes/
        â””â”€ database/
    â”œâ”€ usecases/
    â”œâ”€ entities/
    â””â”€ main.go
â””â”€ docker-compose.development.yml
```
# ç’°å¢ƒã«ã¤ã„ã¦
docker-composeã§ã‚³ãƒ³ãƒ†ãƒŠã‚’ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚ã‚³ãƒ³ãƒ†ãƒŠã®å†…å®¹ã¨ã—ã¦ã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚
- API server
    - Clean Architectureã‚’ä½¿ç”¨ã—ã¦APIã‚µãƒ¼ãƒãƒ¼ã‚’æ§‹ç¯‰ã—ã¾ã™
        - echo + air + gormã‚’æ¡ç”¨
            - developmentã§ã¯é–‹ç™ºåŠ¹ç‡å‘ä¸Šã®ç‚ºã«airã‚’æ¡ç”¨
- Database
    - ãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–ã‚’è¡Œã„ã¾ã™
        - MySQL8.0ã‚’æ¡ç”¨
- Swagger UI
    - Swaggerã®UIã‚’æ§‹ç¯‰ã—ã¾ã™
- Swagger Editor
    - openapi.yamlã‚’ä½œæˆãƒ»æ›´æ–°ã—ã¾ã™
        - goaã‚’æ¡ç”¨

è©³ç´°ã«ã¤ã„ã¦ã¯docker-compose.development.ymlã‚„dockerãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚åˆæœŸãƒ‡ãƒ¼ã‚¿ç”¨ã®sqlãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ä½œæˆã—ã¦ã„ã¾ã™ã€‚
https://github.com/yantera/clean-architecture-for-go

# Clean Architectureã«ã¤ã„ã¦
ä»Šå›ã¯ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«æ²¿ã£ã¦ã©ã®ã‚ˆã†ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã§ã©ã®ã‚ˆã†ãªå½¹å‰²ã‚’æŒ¯ã£ã¦ã„ã‚‹ã‹ã®ã¿èª¬æ˜ã—ã¦ã„ã¾ã™ã€‚ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ã¤ã„ã¦ã¯ã”è‡ªèº«ã§èª¿ã¹ã¦ãã ã•ã„ã€‚

### Adapters
ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã¯å¤–éƒ¨ã¨é€šä¿¡ã™ã‚‹ç‚ºã®å‡¦ç†ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

- Controllers
    - Infrastructuresã§å—ã‘ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚Šã¾ã™ã€‚
        - ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã£ãŸå¾Œã€interactorã«å‡¦ç†ã‚’æŠ•ã’ã‚‹ãŸã‚ã®åˆæœŸåŒ–ã‚‚è¡Œã„ã¾ã™ã€‚
```go:search.go
package guest

import (
	gateway "api/server/adapters/gateways"
	usecase "api/server/usecases/guest"
	"github.com/labstack/echo/v4"
	"strconv"
)

type GuestController struct {
	Interactor usecase.GuestInteractor
}

func InitGuestController(sqlHandler gateway.SQLHandler) *GuestController {
	return &GuestController{
		Interactor: usecase.GuestInteractor{
			GuestPort: &gateway.GuestRepository{
				SQLHandler: sqlHandler,
			},
		},
	}
}

func (controller *GuestController) Show(c echo.Context) (err error) {
	id, _ := strconv.Atoi(c.Param("id"))
	guest, err := controller.Interactor.GuestByID(id)
	if err != nil {
		c.JSON(500, err)
		return
	}
	c.JSON(200, guest)
	return
}

func (controller *GuestController) Index(c echo.Context) (err error) {
	guests, err := controller.Interactor.Guests()
	if err != nil {
		c.JSON(500, err)
		return
	}
	c.JSON(200, guests)
	return
```
- Gateways
    - å¤–éƒ¨ãƒ„ãƒ¼ãƒ«ã¨ç¹‹ããŸã‚ã®interfaceã«ãªã‚Šã¾ã™ã€‚
        - åŸºæœ¬çš„ã«ã¯interfaceã®å®šç¾©ã¨interfaceã‚’ä»‹ã—ã¦å¤–éƒ¨ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹å‡¦ç†ã‚’å®šç¾©ã—ã¾ã™ã€‚
```go:guest_repository.go
package gateways

import (
	"api/server/entities"
)

type GuestRepository struct {
	SQLHandler
}

func (repo *GuestRepository) FindByID(id int) (guest entities.Guest, err error) {
	if err = repo.Find(&guest, id).Error; err != nil {
		return
	}
	return
}

func (repo *GuestRepository) FindAll() (guests entities.Guests, err error) {
	if err = repo.Find(&guests).Error; err != nil {
		return
	}
	return
}
```
```go:sqlhandler.go
package gateways

import (
	"gorm.io/gorm"
)

type SQLHandler interface {
	First(interface{}, ...interface{}) *gorm.DB
	Last(interface{}, ...interface{}) *gorm.DB
	Take(interface{}, ...interface{}) *gorm.DB
	Find(interface{}, ...interface{}) *gorm.DB
}
```
- Presenter
    - å¤–éƒ¨ã«ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã™ã‚‹éš›ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã—ã¾ã™ã€‚
        - å®šç¾©ã¯ã—ã¦ã„ã¾ã™ãŒä»Šå›ã¯æœªä½¿ç”¨ã§ã™ã€‚
### Infrastructures
ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å¤–éƒ¨ã¸é€šä¿¡ã™ã‚‹ãŸã‚ã®å‡¦ç†ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

- Routes
    - ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¡Œã„ã¾ã™ã€‚

Routesã¯ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒå¢—ãˆã‚‹ã¨å¯èª­æ€§ãŒæ‚ªããªã‚‹ã®ã§ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’åˆ‡ã£ã¦ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²å‡ºæ¥ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚ã‚„ã‚Šéãã ã¨æ€ã†æ–¹ã¯route.goã ã‘ã§è‰¯ã„ã¨æ€ã„ã¾ã™ã€‚
```
â”œâ”€ infrastructure/
    â”œâ”€ routes/
        â””â”€ guest.go
    â””â”€ route.go
```
```go:route.go
package infrastructure

import (
	"api/server/infrastructure/routes"
	"github.com/labstack/echo/v4"
	"github.com/labstack/echo/v4/middleware"
)

func Run() {
	e := echo.New()

	e.Use(middleware.Logger())
	e.Use(middleware.Recover())
	e.Use(middleware.CORS())

	routes.InitGuest(e)

	e.Logger.Fatal(e.Start(":1323"))
}
```
```go:guest.go
package routes

import (
	controller "api/server/adapters/controllers/guest"
	"api/server/infrastructure/database"
	"github.com/labstack/echo/v4"
)

func InitGuest(e *echo.Echo) {
	guestController := controller.InitGuestController(database.InitSQLHandler())

	e.GET("/guests/:id", func(c echo.Context) error { return guestController.Show(c) })
	e.GET("/guests", func(c echo.Context) error { return guestController.Index(c) })
}
```
- Database
    - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®åˆæœŸè¨­å®šã‚’è¡Œã„ã¾ã™ã€‚
```go:sql_handler.go
package database

import (
	"fmt"
	"gorm.io/driver/mysql"
	"gorm.io/gorm"
	"gorm.io/gorm/logger"
	"log"
	"os"
	"time"

	"api/server/adapters/gateways"
)

type SQLHandler struct {
	db *gorm.DB
}

func InitSQLHandler() gateways.SQLHandler {
	user := os.Getenv("DB_USER")
	pass := os.Getenv("DB_PASSWORD")
	containerName := os.Getenv("DB_CONTAINER_NAME")
	port := os.Getenv("DB_PORT")
	dbName := os.Getenv("DB_NAME")

	newLogger := logger.New(
		log.New(os.Stdout, "\r\n", log.LstdFlags), // io writer
		logger.Config{
			SlowThreshold:             time.Second, // Slow SQL threshold
			LogLevel:                  logger.Info, // Log level
			IgnoreRecordNotFoundError: true,        // Ignore ErrRecordNotFound error for logger
			Colorful:                  false,       // Disable color
		},
	)

	dsn := fmt.Sprintf("%s:%s@tcp(%s:%s)/%s", user, pass, containerName, port, dbName)
	db, err := gorm.Open(mysql.Open(dsn), &gorm.Config{
		Logger: newLogger,
	})
	if err != nil {
		panic(err)
	}
	sqlHandler := new(SQLHandler)
	sqlHandler.db = db
	return sqlHandler
}

func (handler *SQLHandler) First(out interface{}, where ...interface{}) *gorm.DB {
	return handler.db.First(out, where...)
}

func (handler *SQLHandler) Take(out interface{}, where ...interface{}) *gorm.DB {
	return handler.db.Take(out, where...)
}

func (handler *SQLHandler) Last(out interface{}, where ...interface{}) *gorm.DB {
	return handler.db.Last(out, where...)
}

func (handler *SQLHandler) Find(out interface{}, where ...interface{}) *gorm.DB {
	return handler.db.Find(out, where...)
}
```
### Usecases
- Entitiesã‚„Gatewaysã‚’å‘¼ã¶å‡¦ç†ã‚’å®Ÿè£…ã—ã¾ã™ã€‚
    - å€‹äººçš„ã«ã¯æ‰€è¬‚ã‚µãƒ¼ãƒ“ã‚¹ã¨ä¼¼ãŸã‚ˆã†ãªå½¹å‰²ã ã¨æ€ã£ã¦ã„ã¾ã™ã€‚

ã‚ãˆã¦Entityæ¯ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’åˆ†ã‘ã¦ã„ã¾ã™ã€‚ã™ã¹ã¦ã®Usecaseã‚’å‘¼ã¶ã®ã§ã¯ãªãã€å¿…è¦ãªUsecaseã®ã¿å‘¼ã¹ã‚‹ã‚ˆã†ã«ã—ãŸã„ã‹ã‚‰ã“ã®ã‚ˆã†ã«ä½œæˆã—ã¦ã„ã¾ã™ã€‚
```
usecases/
    â””â”€ guest
        â”œâ”€ interactor.go
        â””â”€ port.go
```
```go:interactor.go
package guest

import (
	"api/server/entities"
)

type GuestInteractor struct {
	GuestPort GuestPort
}

func (interactor *GuestInteractor) GuestByID(id int) (guest entities.Guest, err error) {
	guest, err = interactor.GuestPort.FindByID(id)
	return
}

func (interactor *GuestInteractor) Guests() (guests entities.Guests, err error) {
	guests, err = interactor.GuestPort.FindAll()
	return
}
```
```go:port.go
package guest

import (
	"api/server/entities"
)

type GuestPort interface {
	FindByID(id int) (entities.Guest, error)
	FindAll() (entities.Guests, error)
}
```
### Entities
- ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã—ã¾ã™ã€‚
    - è‰²ã‚“ãªä¼šç¤¾ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒã‚ã‚‹ã®ã§ä¸€æ¦‚ã«è¨€ãˆã¾ã›ã‚“ãŒã€å¼·ã„ã¦è¨€ã†ãªã‚‰ä½•ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆãƒ»æ›´æ–°ãƒ»èª­è¾¼ã¿ãƒ»å‰Šé™¤ã‚’ã—ãŸã„ã®ã‹è€ƒãˆã¦ãã ã•ã„ã€‚
```go:guest.go
package entities

type Guests []Guest

type Guest struct {
	ID            int    `json:"id" param:"id"`
	FirstName     string `json:"first_name"`
	FirstNameKana string `json:"first_name_kana"`
	LastName      string `json:"last_name"`
	LastNameKana  string `json:"last_name_kana"`
	Gender        int    `json:"gender"`
	Birthday      string `json:"birthday"`
	Tel           int    `json:"tel"`
	Email         string `json:"email"`
}
```
# æœ€å¾Œã«
ã“ã“ã¾ã§èª­ã‚“ã§ä¸‹ã•ã‚Šã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚
ã‚ãã¾ã§ä»Šå›ã®å®Ÿè£…ã¯è€ƒãˆã®ä¸€ã¤ã ã¨æ€ã£ã¦ã„ã¾ã™ã€‚è‰¯ã„ã‚¢ã‚¤ãƒ‡ã‚£ã‚¢ã‚„æ”¹å–„ç‚¹ãŒã‚ã‚‹ãªã¨æ€ã†æ–¹ã¯æ„è¦‹ã‚’é ‚ã‘ã¾ã™ã¨å¹¸ã„ã§ã™ã€‚

ä»Šå›ã®æ§‹æˆã¯ã“ã®ãƒšãƒ¼ã‚¸ã«ã‚ã‚‹ã®ã§ã€èˆˆå‘³ãŒã‚ã‚‹æ–¹ã¯æ˜¯éè©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
https://github.com/yantera/clean-architecture-for-go